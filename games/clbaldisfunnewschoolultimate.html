<!DOCTYPE html>


<!-- Ultimate Game Stash file--> 
<!-- For the regularly updating doc go to https://docs.google.com/document/d/1_FmH3BlSBQI7FGgAQL59-ZPe8eCxs35wel6JUyVaG8Q/ -->


<html lang="en-us">
<base href="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/bfnsu/">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Unity WebGL Player | Baldi's Fun New School Plus Ultimate Edition</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">
</head>

<body>
  <div id="unity-container" class="unity-desktop">
    <canvas id="unity-canvas" width=960 height=600></canvas>
    <div id="unity-loading-bar">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"> </div>
    <div id="unity-footer">
      <div id="unity-webgl-logo"></div>
      <div id="unity-fullscreen-button"></div>
      <div id="unity-build-title">Baldi's Fun New School Plus Ultimate Edition</div>
    </div>
  </div>
  <script>
    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingBar = document.querySelector("#unity-loading-bar");
    var progressBarFull = document.querySelector("#unity-progress-bar-full");
    var fullscreenButton = document.querySelector("#unity-fullscreen-button");
    var warningBanner = document.querySelector("#unity-warning");

    function unityShowBanner(msg, type) {
      function updateBannerVisibility() {
        warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
      }
      var div = document.createElement('div');
      div.innerHTML = msg;
      warningBanner.appendChild(div);
      if (type == 'error') div.style = 'background: red; padding: 10px;';
      else {
        if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
        setTimeout(function() {
          warningBanner.removeChild(div);
          updateBannerVisibility();
        }, 5000);
      }
      updateBannerVisibility();
    }

    window.mergedBlobUrls = {};
    window.assetsReady = false;

    async function mergeSplitFile(fileUrlBase, numParts) {
      const partUrls = Array.from({ length: numParts }, (_, i) => 
        `${fileUrlBase}.part${i + 1}`
      );

      try {
        const responses = await Promise.all(
          partUrls.map(url => fetch(url))
        );

        if (responses.some(r => !r.ok)) {
          return null;
        }

        const parts = await Promise.all(
          responses.map(r => r.arrayBuffer())
        );

        const combinedBlob = new Blob(parts, {
          type: 'application/octet-stream'
        });

        return URL.createObjectURL(combinedBlob);
      } catch (error) {
        return null;
      }
    }

    function setupXHRInterceptor() {
      if (window.xhrInterceptorInstalled) {
        return;
      }
      
      const originalOpen = XMLHttpRequest.prototype.open;
      const originalSend = XMLHttpRequest.prototype.send;

      XMLHttpRequest.prototype.open = function(method, url, ...args) {
        this._url = url;
        this._method = method;
        this._args = args;
        
        let finalUrl = url;
        const decodedUrl = decodeURIComponent(url);
        
        for (const [filename, blobUrl] of Object.entries(window.mergedBlobUrls)) {
          if (url.includes(encodeURIComponent(filename)) || 
              decodedUrl.includes(filename) || 
              url.includes(filename)) {
            finalUrl = blobUrl;
            break;
          }
        }
        
        return originalOpen.call(this, method, finalUrl, ...args);
      };

      XMLHttpRequest.prototype.send = function(...args) {
        const xhr = this;
        
        if (!window.assetsReady) {
          const checkReady = setInterval(() => {
            if (window.assetsReady) {
              clearInterval(checkReady);
              originalSend.apply(xhr, args);
            }
          }, 50);
          return;
        }
        
        return originalSend.apply(this, args);
      };
      
      window.xhrInterceptorInstalled = true;
    }

    function setupFetchInterceptor() {
      if (window.fetchInterceptorInstalled) {
        return;
      }

      const originalFetch = window.fetch;
      window.fetch = function(url, ...args) {
        let finalUrl = url;
        const decodedUrl = typeof url === 'string' ? decodeURIComponent(url) : '';
        
        for (const [filename, blobUrl] of Object.entries(window.mergedBlobUrls)) {
          if ((typeof url === 'string' && 
              (url.includes(encodeURIComponent(filename)) || 
               decodedUrl.includes(filename) || 
               url.includes(filename)))) {
            finalUrl = blobUrl;
            break;
          }
        }
        
        return originalFetch.call(this, finalUrl, ...args);
      };

      window.fetchInterceptorInstalled = true;
    }

    async function prepareGameAssets() {
      try {
        window.assetsReady = false;
        delete window.xhrInterceptorInstalled;
        delete window.fetchInterceptorInstalled;
        window.mergedBlobUrls = {};
        
        setupXHRInterceptor();
        setupFetchInterceptor();
        
        const filesToMerge = [
          { filename: 'Build/BFNSPUE Alpha 6 Part 2b WebGL.data', parts: 9 },
          { filename: 'Build/BFNSPUE Alpha 6 Part 2b WebGL.wasm', parts: 2 }
        ];
        
        for (const file of filesToMerge) {
          const blobUrl = await mergeSplitFile(file.filename, file.parts);
          if (blobUrl) {
            window.mergedBlobUrls[file.filename] = blobUrl;
          }
        }
        
        window.assetsPrepared = true;
        window.assetsReady = true;
        
      } catch (error) {
        window.assetsPrepared = false;
        window.assetsReady = true;
      }
    }

    prepareGameAssets().then(() => {
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/BFNSPUE Alpha 6 Part 2b WebGL.loader.js";
      var config = {
        dataUrl: buildUrl + "/BFNSPUE Alpha 6 Part 2b WebGL.data",
        frameworkUrl: buildUrl + "/BFNSPUE Alpha 6 Part 2b WebGL.framework.js",
        codeUrl: buildUrl + "/BFNSPUE Alpha 6 Part 2b WebGL.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "JohnsterSpaceGames",
        productName: "Baldi's Fun New School Plus Ultimate Edition",
        productVersion: "0.2.5b",
        showBanner: unityShowBanner,
      };

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-mobile";
        config.devicePixelRatio = 1;
        unityShowBanner('WebGL builds are not supported on mobile devices.');
      } else {
        canvas.style.width = "960px";
        canvas.style.height = "600px";
      }
      canvas.style.background = "url('" + buildUrl + "/BFNSPUE Alpha 6 Part 2b WebGL.jpg') center / cover";
      loadingBar.style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
        }).then((unityInstance) => {
          loadingBar.style.display = "none";
          fullscreenButton.onclick = () => {
            unityInstance.SetFullscreen(1);
          };
        }).catch((message) => {
          alert(message);
        });
      };
      document.body.appendChild(script);
    });
  </script>
</body>

</html>